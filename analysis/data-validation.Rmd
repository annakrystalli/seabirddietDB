---
title: "Data validation"
author: "Anna Krystalli"
date: "29/06/2018"
runtime: shiny
output: html_document
---

```{r}
library(dplyr)
```



```{r}
seabirddiet <- readr::read_csv(here::here("output", "seabirddiet.csv"))
```

```{r}
names(seabirddiet)
```

## check for duplicate species records

Check for duplicate entries in the following variable combination:

- startyear,  
- endyear,  
- location,  
- pred_species,  
- prey_taxon,  
- pred_breeding_status,  
- pred_age_group,  
- prey_age_group,  
- ref_ids 
- sample_size 

```{r}
dupes <- seabirddiet %>% 
    # identify duplicates
    janitor::get_dupes(startyear, endyear, location, pred_species, prey_taxon, pred_breeding_status, pred_age_group, 
                       prey_age_group, ref_ids, sample_size) %>% 
    # reorder table for easier visual examination
    select(ref_ids, dupe_count, startyear, endyear, location, pred_valid_name, prey_taxon, freq_occ, sample_size, pred_age_group,  prey_age_group, everything()) 
```

### all dupes

```{r}
dupes %>% DT::datatable()
```

### REF067 (Snow 1960 Ibis 102, 554-575)

<https://onlinelibrary.wiley.com/doi/epdf/10.1111/j.1474-919X.1960.tb07132.x>

```{r}
dupes %>% slice(1:2) %>% DT::datatable()
```

Looking at the original source below, it seems that the `prey_taxon` for `freq_occ` entry of 0.037 _(1/27 = `r 1/27`)_ should be **crustacea** rather than Ammodytidae.

![](assets/ref067.png)


### REF048 (Mills 1969 Scottish Birds 5,264-268)

<https://www.the-soc.org.uk/files/docs/about-us/publications/scottish-birds/sb-vol05-no05.pdf>

#### _Actinopterygii_

```{r}
dupes %>% slice(3:4) %>% DT::datatable()
```

Looking at the original source table really can't figure out what these duplicate entries are refering to. Using `freq_occ` in our data that would equate to the following percentages:
```{r}
dupes %>% slice(3:4) %>% 
    select(prey_taxon, freq_occ, sample_size) %>%
    mutate(no_orig = freq_occ * sample_size)
```

![](assets/ref048.png)

<br>

#### _Littorina saxatilis_

```{r}
dupes %>% slice(5:6) %>% DT::datatable()
```

This seems a clear duplicate. At the same time, the numbers don't seem to correspond to the original data table.

```{r}
dupes %>% slice(5:6) %>% 
    select(prey_taxon, freq_occ, sample_size) %>%
    mutate(no_orig = freq_occ * sample_size)
```




## `prey_orig_descr` validation

I've noticed a number of odd matches of the values in `prey_taxon` to the values in `prey_orig_descr`. `prey_orig_descr` was `Prey.type` in the original dataset, defined as the "terms used by the study" and I'm using `prey_taxon` instead of `Prey.species` as it seems more appropriate given prey is not consistently identified to species level. I'm a little confused by some of the current matches (see below).

- Q1: Am I misunderstanding what `prey_orig_descr` (ie `Prey.type`) represents? 
- Q2: If it is not directly related to `prey_taxon` (ie `prey_taxon` is the more accurate taxonomic descriptor) and given the messiness of it as a variable anyways, I am wondering what it is adding and whether we should just remove it?

```{r}
prey_taxon_qa <- seabirddiet %>% 
    filter(!is.na(prey_orig_descr)) %>%
    select(prey_orig_descr, prey_taxon, prey_valid_name, 
           prey_valid_aphia_id, prey_age_group) %>% 
    distinct() %>% 
    arrange(prey_taxon) %>%
    mutate(sub_id = 1:nrow(.)) %>%
    select(sub_id, everything())
    
```

Here is a table of all the current unique combinations of variables `prey_taxon` and `prey_orig_descr`, with additional taxonomic information validated through WoRMS. I suggest you have a browse through yourselves to get a feel for some of the inconsistencies. This table is editable but please don't edit `prey_taxon` and `prey_orig_descr` directly. Instead use columns `new_prey_orig_descr` and `new_prey_taxon` respectively to make edits that will be applied later programmatically. Or you can just mark a row as `suspect` by overwriting the **0** with a **1**. 

Further down I've also pulled out some specific inconsistencies. You can use `sub_id` to locate them in this editable table and correct them or mark them as suspect if required.



```{r}

prey_taxon_qa %>%
    mutate(suspect = 0,
        new_prey_orig_descr = prey_orig_descr, 
           new_prey_taxon = prey_taxon) %>%
    seabirdPrey::mn_edit_df()
```

### sandeels

While most seem ok, there are a number of entries where the same `prey_orig_descr` is matched to different `prey_taxon`

```{r}
prey_taxon_qa %>% filter(stringr::str_detect(prey_orig_descr, "sandeel")) %>% knitr::kable()
```

I'll highlight especially the row where it 

```{r}
seabirddiet %>% filter(stringr::str_detect(prey_orig_descr, "sandeel"), prey_valid_name == "Arthropoda") %>%
    select(prey_orig_descr, prey_taxon, prey_valid_name, 
           prey_valid_aphia_id, prey_age_group, ref_ids) %>% 
    knitr::kable()
```


### clupeidea


```{r}
prey_taxon_qa %>% filter(prey_orig_descr %in% c("clupeidae", "clupeidea"))
```



```{r}
find_suspect_preytype_ref <- function(seabirddiet){
    
    library(shiny)
    library(dplyr)
    
    shinyApp(
        ui = fluidPage(
            fluidRow(
                column(4, textInput("prey_orig_descr", label = h3(code("prey_orig_descr")), value = "sandeel")),
                column(4, textInput("prey_taxon", label = h3(code("prey_taxon")), value = "Arthropoda"))),
            fluidRow(tableOutput("table"))),
        
        server = function(input, output, session) {
            output$table <- renderTable({ 
                seabirddiet[seabirddiet$prey_orig_descr == input$prey_orig_descr & 
                                seabirddiet$prey_valid_name == input$prey_taxon, 
                            c("prey_orig_descr", "prey_taxon", "id", "ref_ids")]})
            
        })
}
```

```{r, eval = T}
find_suspect_preytype_ref(seabirddiet)
```

```{r, eval = F}
                seabirddiet %>% filter(prey_orig_descr == input$prey_orig_descr, 
                                       prey_valid_name == input$prey_taxon)
```



# APPENDIX

Useful information tables

## variable recoding

Recoding of variable names from the original dataset supplied to the final output

```{r}
readr::read_csv(here::here("data-raw", "manual_corrections", "mn_seabirddiet_rename.csv")) %>% knitr::kable()
```


## attribute table

Variable metadata

```{r}
readr::read_csv(here::here("data-raw", "metadata", "attributes.csv")) %>% DT::datatable()
```



## References

```{r}
readr::read_csv(here::here("data-raw", "metadata", "references.csv")) %>% DT::datatable()
```

